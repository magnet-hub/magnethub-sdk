<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Catch the Stars - MagnetHub Game</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(180deg, #4facfe 0%, #00f2fe 100%);
        overflow: hidden;
        width: 100vw;
        height: 100vh;
      }

      .game-canvas {
        width: 100vw;
        height: 100vh;
        position: relative;
        overflow: hidden;
        cursor: crosshair;
      }

      .player {
        position: absolute;
        width: 60px;
        height: 60px;
        background: #ff6b6b;
        border-radius: 50%;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        transition: all 0.15s ease;
        box-shadow: 0 5px 20px rgba(255, 107, 107, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        z-index: 10;
      }

      .target {
        position: absolute;
        width: 40px;
        height: 40px;
        background: #ffd93d;
        border-radius: 50%;
        animation: fall 3s linear infinite;
        box-shadow: 0 3px 15px rgba(255, 217, 61, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
      }

      @keyframes fall {
        from {
          top: -50px;
        }
        to {
          top: 100vh;
        }
      }

      .stats {
        position: fixed;
        top: 20px;
        left: 20px;
        right: 20px;
        display: flex;
        justify-content: space-between;
        gap: 20px;
        z-index: 100;
        pointer-events: none;
      }

      .stat-box {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        padding: 15px 25px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
      }

      .stat-box h3 {
        color: #6c757d;
        font-size: 12px;
        margin-bottom: 5px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .stat-box .value {
        color: #667eea;
        font-size: 32px;
        font-weight: 700;
      }

      .game-over {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 40px 60px;
        border-radius: 20px;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        display: none;
        z-index: 200;
      }

      .game-over.show {
        display: block;
      }

      .game-over h2 {
        color: #667eea;
        font-size: 48px;
        margin-bottom: 15px;
      }

      .game-over p {
        color: #6c757d;
        font-size: 24px;
        margin-bottom: 30px;
      }

      .game-over button {
        background: #667eea;
        color: white;
        border: none;
        padding: 15px 40px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 18px;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .game-over button:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      .score-popup {
        position: absolute;
        font-size: 24px;
        font-weight: bold;
        color: #fff;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        animation: scoreFloat 1s ease-out forwards;
        pointer-events: none;
        z-index: 50;
      }

      @keyframes scoreFloat {
        0% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
        100% {
          opacity: 0;
          transform: translateY(-80px) scale(1.5);
        }
      }
    </style>
  </head>
  <body>
    <div class="stats">
      <div class="stat-box">
        <h3>Score</h3>
        <div class="value" id="score">0</div>
      </div>
      <div class="stat-box">
        <h3>High Score</h3>
        <div class="value" id="highScore">0</div>
      </div>
    </div>

    <div class="game-canvas" id="gameCanvas">
      <div class="player" id="player"></div>
      <div class="game-over" id="gameOver">
        <h2>Game Over!</h2>
        <p>Final Score: <strong id="finalScore">0</strong></p>
        <button id="playAgainBtn">Play Again</button>
      </div>
    </div>

    <script type="module">
      import MagnetHubGame from "https://unpkg.com/magnethub-sdk@0.1.1/src/magnethub-game.js";

      // Initialize MagnetHub
      const game = new MagnetHubGame();

      // Game State
      let score = 0;
      let highScore = localStorage.getItem("highScore") || 0;
      let isPlaying = false;
      let isPaused = false;
      let gameInterval = null;
      let difficultyInterval = null;
      let targets = [];
      let playerX = 50;
      let spawnRate = 1000;
      let gameTime = 0;
      let currentLevel = 1;

      // DOM Elements
      const scoreDisplay = document.getElementById("score");
      const highScoreDisplay = document.getElementById("highScore");
      const finalScoreDisplay = document.getElementById("finalScore");
      const gameCanvas = document.getElementById("gameCanvas");
      const player = document.getElementById("player");
      const gameOverScreen = document.getElementById("gameOver");
      const playAgainBtn = document.getElementById("playAgainBtn");

      // Initialize high score display
      highScoreDisplay.textContent = highScore;

      // Update player position
      function updatePlayerPosition(x) {
        playerX = Math.max(5, Math.min(95, x));
        player.style.left = `${playerX}%`;
      }

      // Create falling star
      function createTarget() {
        const target = document.createElement("div");
        target.className = "target";
        target.textContent = "â­";
        target.style.left = `${Math.random() * 90 + 5}%`;

        // Increase difficulty over time
        const duration = Math.max(1.5, 3 - gameTime / 30);
        target.style.animationDuration = `${duration}s`;

        gameCanvas.appendChild(target);
        targets.push(target);

        setTimeout(() => {
          if (target.parentNode) {
            target.remove();
            targets = targets.filter((t) => t !== target);
            // Missed a star - could add penalty here
          }
        }, duration * 1000);

        return target;
      }

      // Show score popup
      function showScorePopup(x, y, points) {
        const popup = document.createElement("div");
        popup.className = "score-popup";
        popup.textContent = `+${points}`;
        popup.style.left = `${x}px`;
        popup.style.top = `${y}px`;
        gameCanvas.appendChild(popup);

        setTimeout(() => popup.remove(), 1000);
      }

      // Check collision with expanded hitbox
      function checkCollision() {
        const playerRect = player.getBoundingClientRect();
        const canvasRect = gameCanvas.getBoundingClientRect();

        // Expand player hitbox for easier catching
        const playerCenterX = playerRect.left + playerRect.width / 2;
        const playerCenterY = playerRect.top + playerRect.height / 2;
        const hitRadius = 40; // Generous hit detection

        targets.forEach((target) => {
          const targetRect = target.getBoundingClientRect();
          const targetCenterX = targetRect.left + targetRect.width / 2;
          const targetCenterY = targetRect.top + targetRect.height / 2;

          // Calculate distance between centers
          const dx = playerCenterX - targetCenterX;
          const dy = playerCenterY - targetCenterY;
          const distance = Math.sqrt(dx * dx + dy * dy);

          if (distance < hitRadius) {
            const points = 10;
            score += points;
            scoreDisplay.textContent = score;

            // Show score popup
            showScorePopup(
              targetRect.left - canvasRect.left,
              targetRect.top - canvasRect.top,
              points
            );

            // Animate player
            player.style.animation = "pulse 0.3s ease";
            setTimeout(() => (player.style.animation = ""), 300);

            target.remove();
            targets = targets.filter((t) => t !== target);

            // Send score update to parent
            game.updateScore(score, { combo: 1 });
          }
        });
      }

      // Start Game
      function startGame() {
        if (isPlaying) return;

        score = 0;
        gameTime = 0;
        spawnRate = 1000;
        currentLevel = 1;
        scoreDisplay.textContent = score;
        gameOverScreen.classList.remove("show");

        isPlaying = true;
        isPaused = false;

        game.gameStart({ level: currentLevel, timestamp: Date.now() });

        gameInterval = setInterval(() => {
          if (!isPaused) {
            createTarget();
            checkCollision();
          }
        }, spawnRate);

        // Continuous collision detection
        const collisionCheck = setInterval(() => {
          if (isPlaying) {
            checkCollision();
          } else {
            clearInterval(collisionCheck);
          }
        }, 50); // Check every 50ms for smooth collision detection

        // Increase difficulty over time
        difficultyInterval = setInterval(() => {
          if (!isPaused) {
            gameTime++;
            if (gameTime % 10 === 0 && spawnRate > 500) {
              spawnRate -= 100;
              clearInterval(gameInterval);
              gameInterval = setInterval(() => {
                if (!isPaused) {
                  createTarget();
                  checkCollision();
                }
              }, spawnRate);
            }
            // Level up every 30 seconds
            if (gameTime % 30 === 0) {
              currentLevel++;
              game.levelStart(currentLevel, { difficulty: "increasing" });
            }
          }
        }, 1000);
      }

      // Pause Game
      function pauseGame() {
        if (!isPlaying) return;
        isPaused = true;
      }

      // Resume Game
      function resumeGame() {
        if (!isPlaying || !isPaused) return;
        isPaused = false;
      }

      // End Game
      function endGame() {
        isPlaying = false;

        if (gameInterval) clearInterval(gameInterval);
        if (difficultyInterval) clearInterval(difficultyInterval);

        targets.forEach((target) => target.remove());
        targets = [];

        // Update high score
        if (score > highScore) {
          highScore = score;
          highScoreDisplay.textContent = highScore;
          localStorage.setItem("highScore", highScore);
          game.setData("highScore", highScore);
        }

        finalScoreDisplay.textContent = score;
        gameOverScreen.classList.add("show");

        game.gameOver({ score, highScore, level: currentLevel });
      }

      // Event Listeners
      playAgainBtn.addEventListener("click", () => {
        gameOverScreen.classList.remove("show");
        startGame();
      });

      gameCanvas.addEventListener("click", (e) => {
        if (!isPlaying || isPaused) return;
        const rect = gameCanvas.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 100;
        updatePlayerPosition(x);
      });

      // Add mousemove for smoother control
      gameCanvas.addEventListener("mousemove", (e) => {
        if (!isPlaying || isPaused) return;
        const rect = gameCanvas.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 100;
        updatePlayerPosition(x);
      });

      // Add touch support for mobile
      gameCanvas.addEventListener("touchmove", (e) => {
        e.preventDefault();
        if (!isPlaying || isPaused) return;
        const rect = gameCanvas.getBoundingClientRect();
        const touch = e.touches[0];
        const x = ((touch.clientX - rect.left) / rect.width) * 100;
        updatePlayerPosition(x);
      });

      // Listen for events from parent
      game.onPause((data) => {
        console.log("Received pause from parent:", data);
        pauseGame();
      });

      game.onResume((data) => {
        console.log("Received resume from parent:", data);
        resumeGame();
      });

      // Notify parent that game is loaded and ready
      game.gameLoaded({
        timestamp: Date.now(),
        title: "Catch the Stars",
        version: "1.0.0",
      });

      console.log("Game loaded and ready!");

      // Auto-start the game after a short delay
      setTimeout(() => {
        startGame();
      }, 1000);
    </script>
  </body>
</html>
